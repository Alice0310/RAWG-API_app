<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚²ãƒ¼ãƒ æ¤œç´¢ & ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <link rel="stylesheet" href="./style.css/style.css" />

  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>ğŸ® ã‚²ãƒ¼ãƒ æ¤œç´¢ & ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>

    <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
    <input type="text" id="searchInput" placeholder="ã‚²ãƒ¼ãƒ åã§æ¤œç´¢" />
    <button id="searchBtn">æ¤œç´¢</button>

    <!-- æ°—ã«ãªã‚‹ãƒªã‚¹ãƒˆãƒœã‚¿ãƒ³ -->
    <button id="favoritesBtn">æ°—ã«ãªã‚‹ãƒªã‚¹ãƒˆ</button>
  </header>

  <main>
    <h2>ã‚²ãƒ¼ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>

    <!-- ä¸¦ã³æ›¿ãˆã‚»ãƒ¬ã‚¯ãƒˆ -->
    <div class="sort-bar">
      <label for="sort-select">ä¸¦ã³æ›¿ãˆï¼š</label>
      <select id="sort-select">
        <option value="-rating">è©•ä¾¡ãŒé«˜ã„é †</option>
        <option value="-added">äººæ°—é †</option>
        <option value="-released">æœ€æ–°ãƒªãƒªãƒ¼ã‚¹é †</option>
        <option value="name">åå‰é †</option>
        <option value="-metacritic">ãƒ¡ã‚¿ã‚¹ã‚³ã‚¢é †</option>
      </select>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ä¸€è¦§è¡¨ç¤º -->
    <div class="game-list"></div>

    <!-- èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º -->
    <div id="loading" style="text-align:center; display:none;">
      <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </main>

  <script>
    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "",
      authDomain: "rawg-api.firebaseapp.com",
      projectId: "rawg-api",
      storageBucket: "rawg-api.firebasestorage.app",
      messagingSenderId: "81137225470",
      appId: "1:81137225470:web:447651297a4aff5525dfaf"
    };

    // FirebaseåˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // RAWG APIã‚­ãƒ¼
    const apiKey = '';

    let currentOrdering = '-rating';  // ä¸¦ã³é †
    let currentQuery = '';            // æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰
    let currentPage = 1;              // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸
    let isLoading = false;            // èª­ã¿è¾¼ã¿ä¸­ãƒ•ãƒ©ã‚°
    let endOfData = false;            // ãƒ‡ãƒ¼ã‚¿çµ‚ç«¯åˆ¤å®š

    // ã‚²ãƒ¼ãƒ å–å¾—é–¢æ•°
    function fetchGames(ordering, query = '', page = 1, append = false) {
      if (isLoading || endOfData) return;

      isLoading = true;
      $('#loading').show();

      const params = {
        key: apiKey,
        ordering: ordering,
        page_size: 20,
        page: page
      };
      if (query) params.search = query;

      axios.get('https://api.rawg.io/api/games', { params })
        .then(res => {
          const games = res.data.results;

          if (games.length === 0) {
            endOfData = true;
            if (!append) $('.game-list').html('<p>ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>');
            return;
          }

          displayGames(games, append);
          currentPage++;
        })
        .catch(err => {
          console.error('ã‚²ãƒ¼ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
          if (!append) $('.game-list').html('<p>ã‚²ãƒ¼ãƒ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>');
        })
        .finally(() => {
          isLoading = false;
          $('#loading').hide();
        });
    }

    // ã‚²ãƒ¼ãƒ è¡¨ç¤ºé–¢æ•°ï¼ˆæ°—ã«ãªã‚‹ãƒœã‚¿ãƒ³ï¼‰
    function displayGames(games, append = false) {
      let html = '';

      games.forEach(game => {
        html += `
          <div class="game-card" data-id="${game.id}" data-name="${game.name}" data-image="${game.background_image}" data-rating="${game.rating}">
            <img src="${game.background_image}" alt="${game.name}" />
            <h3>${game.name}</h3>
            <p>â˜… ${game.rating}</p>
            <button class="add-favorite-btn">æ°—ã«ãªã‚‹</button>
          </div>
        `;
      });

      if (append) {
        $(".game-list").append(html);
      } else {
        $(".game-list").html(html);
      }
    }

    $(document).ready(function () {
      // åˆå›ã‚²ãƒ¼ãƒ å–å¾—
      fetchGames(currentOrdering);

      // ä¸¦ã³æ›¿ãˆå¤‰æ›´
      $('#sort-select').on('change', function () {
        currentOrdering = $(this).val();
        currentPage = 1;
        endOfData = false;
        fetchGames(currentOrdering, currentQuery, currentPage, false);
      });

      // æ¤œç´¢ãƒœã‚¿ãƒ³
      $('#searchBtn').click(function () {
        currentQuery = $('#searchInput').val().trim();
        currentPage = 1;
        endOfData = false;
        fetchGames(currentOrdering, currentQuery, currentPage, false);
      });

      // ã‚²ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã¸
      $('.game-list').on('click', '.game-card', function () {
        const gameId = $(this).data('id');
        window.location.href = `details.html?id=${gameId}`;
      });

      // ã€Œæ°—ã«ãªã‚‹ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
      $('.game-list').on('click', '.add-favorite-btn', function (e) {
        e.stopPropagation(); // è©³ç´°é·ç§»ã‚’æ­¢ã‚ã‚‹

        const $card = $(this).closest('.game-card');
        const gameId = $card.data('id');
        const gameName = $card.data('name');
        const gameImage = $card.data('image');
        const gameRating = $card.data('rating');

        // Firestoreã«ä¿å­˜
        db.collection('favorites').doc(String(gameId)).set({
          id: gameId,
          name: gameName,
          background_image: gameImage,
          rating: gameRating
        })
          .then(() => {
            alert(`ã€Œ${gameName}ã€ã‚’æ°—ã«ãªã‚‹ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
          })
          .catch(err => {
            console.error('æ°—ã«ãªã‚‹è¿½åŠ ã‚¨ãƒ©ãƒ¼:', err);
            alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
      });

      // ã€Œæ°—ã«ãªã‚‹ãƒªã‚¹ãƒˆã€ãƒœã‚¿ãƒ³ã§ãƒšãƒ¼ã‚¸é·ç§»
      $('#favoritesBtn').click(function () {
        window.location.href = 'favorite.html';
      });

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡é™èª­ã¿è¾¼ã¿
      $(window).on('scroll', function () {
        if ($(window).scrollTop() + $(window).height() >= $(document).height() - 200) {
          fetchGames(currentOrdering, currentQuery, currentPage, true);
        }
      });
    });
  </script>
</body>
</html>
